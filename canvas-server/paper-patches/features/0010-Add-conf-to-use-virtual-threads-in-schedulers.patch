From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Dueris <jedimastertoothless@hotmail.com>
Date: Sat, 1 Feb 2025 23:09:32 -0800
Subject: [PATCH] Add conf to use virtual threads in schedulers


diff --git a/src/main/java/io/papermc/paper/util/MCUtil.java b/src/main/java/io/papermc/paper/util/MCUtil.java
index 0256e33a4e25fcbea7a307d5894920ba65a49552..ab56ff037b041ccded8df70c57416a54b02640f4 100644
--- a/src/main/java/io/papermc/paper/util/MCUtil.java
+++ b/src/main/java/io/papermc/paper/util/MCUtil.java
@@ -4,6 +4,7 @@ import ca.spottedleaf.moonrise.common.util.TickThread;
 import com.google.common.collect.Collections2;
 import com.google.common.collect.Lists;
 import com.google.common.util.concurrent.ThreadFactoryBuilder;
+import io.canvasmc.canvas.Config;
 import io.papermc.paper.math.BlockPosition;
 import io.papermc.paper.math.FinePosition;
 import io.papermc.paper.math.Position;
@@ -38,7 +39,11 @@ public final class MCUtil {
             run.run();
         }
     };
-    public static final ExecutorService ASYNC_EXECUTOR = Executors.newFixedThreadPool(2, new ThreadFactoryBuilder()
+    // Canvas start
+    public static final ExecutorService ASYNC_EXECUTOR = Config.INSTANCE.virtualThreads.shouldReplaceAsyncExecutor() ?
+        Executors.newVirtualThreadPerTaskExecutor() :
+        Executors.newFixedThreadPool(2, new ThreadFactoryBuilder()
+    // Canvas end
         .setNameFormat("Paper Async Task Handler Thread - %1$d")
         .setUncaughtExceptionHandler(new net.minecraft.DefaultUncaughtExceptionHandlerWithName(MinecraftServer.LOGGER))
             .setThreadFactory(TickThread::new) // Canvas
diff --git a/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java b/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java
index 0ca279fb71d39c81b1f608e0ee9ba3e498d55fa3..dedba25eca417a33ec652cbb3d856ea0f5e033b3 100644
--- a/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java
+++ b/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java
@@ -25,6 +25,7 @@ package org.bukkit.craftbukkit.scheduler;
 
 import com.destroystokyo.paper.ServerSchedulerReportingWrapper;
 import com.google.common.util.concurrent.ThreadFactoryBuilder;
+import io.canvasmc.canvas.Config;
 import org.bukkit.plugin.Plugin;
 
 import java.util.ArrayList;
@@ -38,7 +39,11 @@ import java.util.concurrent.TimeUnit;
 
 public class CraftAsyncScheduler extends CraftScheduler {
 
-    private final ThreadPoolExecutor executor = new ThreadPoolExecutor(
+    // Canvas start
+    private final ThreadPoolExecutor executor = Config.INSTANCE.virtualThreads.shouldReplaceBukkitScheduler() ?
+        Executors.newVirtualThreadPerTaskExecutor() :
+        new ThreadPoolExecutor(
+    // Canvas end
             4, Integer.MAX_VALUE,30L, TimeUnit.SECONDS, new SynchronousQueue<>(),
             new ThreadFactoryBuilder().setNameFormat("Craft Scheduler Thread - %1$d").build());
     private final Executor management = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder()
