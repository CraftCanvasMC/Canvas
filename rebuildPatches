#!/bin/bash

set -e

echo "Processing file patches..."

declare -A gradle_tasks

process_changes() {
  local dir="$1"
  local project="$2"

  if [ ! -d "$dir" ]; then
    echo "Error: The directory '$dir' does not exist or is not valid."
    exit 1
  fi

  cd "$dir"

  if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "Changes detected in $dir. Running Gradle fixup and rebuild tasks."
    gradle_tasks["fixup${project}FilePatches"]="true"
    gradle_tasks["rebuild${project}FilePatches"]="true"
  else
    echo "No changes detected in $dir"
  fi

  cd - > /dev/null
}

run_gradle_task() {
  local task="$1"
  if [ "${gradle_tasks[$task]}" = "true" ]; then
    echo "Running Gradle task: $task"
    ./gradlew "$task"
    if [ $? -ne 0 ]; then
      echo "Gradle task '$task' failed."
      exit 1
    fi
    echo "Gradle task '$task' completed successfully."
  else
    echo "Skipping Gradle task '$task' as no changes were detected."
  fi
}

process_changes "./purpur-server/" "PurpurServer"
process_changes "./purpur-api/" "PurpurApi"
process_changes "./paper-server/" "PaperServer"
process_changes "./paper-api/" "PaperApi"
process_changes "./canvas-server/src/minecraft/java" "Minecraft"

echo "Running fixup tasks..."
run_gradle_task "fixupPurpurApiFilePatches"
run_gradle_task "fixupPaperApiFilePatches"
run_gradle_task "fixupPurpurServerFilePatches"
run_gradle_task "fixupPaperServerFilePatches"
run_gradle_task "fixupMinecraftFilePatches"

echo "Running rebuild tasks..."
run_gradle_task "rebuildPurpurApiFilePatches"
run_gradle_task "rebuildPaperApiFilePatches"
run_gradle_task "rebuildPurpurServerFilePatches"
run_gradle_task "rebuildPaperServerFilePatches"
run_gradle_task "rebuildMinecraftFilePatches"
