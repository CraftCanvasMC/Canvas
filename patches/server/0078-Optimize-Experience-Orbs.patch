From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PurpleWolfMC <jedimastertoothless@hotmail.com>
Date: Tue, 9 Apr 2024 12:22:02 -0700
Subject: [PATCH] Optimize Experience Orbs


diff --git a/src/main/java/me/dueris/canvas/CanvasConfig.java b/src/main/java/me/dueris/canvas/CanvasConfig.java
index fa211b782c4fb632f58cc097becb5487d44f1a98..931ba5656ee59aeac26183c3eaf9dc2b8c917ae6 100644
--- a/src/main/java/me/dueris/canvas/CanvasConfig.java
+++ b/src/main/java/me/dueris/canvas/CanvasConfig.java
@@ -208,6 +208,10 @@ public class CanvasConfig {
     public static int spawnerMaxPlayerRange = 16;
     public static boolean spawnerEntitiesHaveAI = true;
     public static int maxConnectionThreads = 5;
+ 
+    public static boolean playerInstaAbsorbOrbs = false;
+    public static boolean useCanvasOrbOptimizations = false;
+    public static double orbMergeSearchInfaltionRadius = 0.9;
 
     private static void logger(){
         obfuscateIps = getBoolean("logger.obfuscateIps", obfuscateIps);
@@ -216,6 +220,10 @@ public class CanvasConfig {
         disableFootsteps = getBoolean("disableFootsteps", disableFootsteps);
         checkLightForSnow = getBoolean("checkLightForSnow", checkLightForSnow);
         onlyPlayersPushEntities = getBoolean("onlyPlayersPushEntities", onlyPlayersPushEntities);
+ 
+        playerInstaAbsorbOrbs = getBoolean("playerInstaAbsorbOrbs", playerInstaAbsorbOrbs);
+        useCanvasOrbOptimizations = getBoolean("useCanvasOrbOptimizations", useCanvasOrbOptimizations);
+        orbMergeSearchInfaltionRadius = getDouble("orbMergeSearchInfaltionRadius", orbMergeSearchInfaltionRadius);
     }
     private static void plugins(){
         wantChunky = getBoolean("plugins.use_provided_chunky", wantChunky);
diff --git a/src/main/java/net/minecraft/world/entity/ExperienceOrb.java b/src/main/java/net/minecraft/world/entity/ExperienceOrb.java
index 139fe6c405f927cab23d1b72f5a4c81b71d95ec1..92795873e165d2912c3c7fe1a15a7f3da735edda 100644
--- a/src/main/java/net/minecraft/world/entity/ExperienceOrb.java
+++ b/src/main/java/net/minecraft/world/entity/ExperienceOrb.java
@@ -21,6 +21,7 @@ import net.minecraft.world.level.entity.EntityTypeTest;
 import net.minecraft.world.phys.AABB;
 import net.minecraft.world.phys.Vec3;
 // CraftBukkit start
+import org.bukkit.craftbukkit.entity.CraftExperienceOrb;
 import org.bukkit.craftbukkit.event.CraftEventFactory;
 import org.bukkit.event.entity.EntityRemoveEvent;
 import org.bukkit.event.entity.EntityTargetLivingEntityEvent;
@@ -139,7 +140,21 @@ public class ExperienceOrb extends Entity {
         }
 
         if (this.tickCount % 20 == 1) {
-            this.scanForEntities();
+            // Canvas start
+            if (this.followingPlayer == null || this.followingPlayer.distanceToSqr((Entity) this) > 64.0D) {
+                this.followingPlayer = this.level().getNearestPlayer(this, 8.0D);
+            }
+            if(me.dueris.canvas.CanvasConfig.useCanvasOrbOptimizations){
+                List<ExperienceOrb> orbs = this.level().getEntities(EntityTypeTest.forClass(ExperienceOrb.class), this.getBoundingBox().inflate(me.dueris.canvas.CanvasConfig.orbMergeSearchInfaltionRadius), orb -> orb != this && !orb.isRemoved());
+                if(orbs.size() > 0){
+                    orbs.forEach(orb -> {
+                        this.count += orb.count;
+                        this.age = Math.min(this.age, orb.age);
+                        orb.remove(RemovalReason.DISCARDED);
+                    });
+                }
+            } else this.scanForEntities();
+            // Canvas end
         }
 
         if (this.followingPlayer != null && (this.followingPlayer.isSpectator() || this.followingPlayer.isDeadOrDying())) {
@@ -197,9 +212,10 @@ public class ExperienceOrb extends Entity {
     }
 
     private void scanForEntities() {
+        /* // Canvas
         if (this.followingPlayer == null || this.followingPlayer.distanceToSqr((Entity) this) > 64.0D) {
             this.followingPlayer = this.level().getNearestPlayer(this, 8.0D);
-        }
+        } */ // Canvas
 
         if (this.level() instanceof ServerLevel) {
             List<ExperienceOrb> list = this.level().getEntities(EntityTypeTest.forClass(ExperienceOrb.class), this.getBoundingBox().inflate(0.5D), this::canMerge);
@@ -320,8 +336,13 @@ public class ExperienceOrb extends Entity {
     @Override
     public void playerTouch(Player player) {
         if (!this.level().isClientSide) {
-            if (player.takeXpDelay == 0 && new com.destroystokyo.paper.event.player.PlayerPickupExperienceEvent(((net.minecraft.server.level.ServerPlayer) player).getBukkitEntity(), (org.bukkit.entity.ExperienceOrb) this.getBukkitEntity()).callEvent()) { // Paper - PlayerPickupExperienceEvent
+            if ((me.dueris.canvas.CanvasConfig.playerInstaAbsorbOrbs || player.takeXpDelay == 0) && new com.destroystokyo.paper.event.player.PlayerPickupExperienceEvent(((net.minecraft.server.level.ServerPlayer) player).getBukkitEntity(), (org.bukkit.entity.ExperienceOrb) this.getBukkitEntity()).callEvent()) { // Paper - PlayerPickupExperienceEvent // Canvas
                 player.takeXpDelay = CraftEventFactory.callPlayerXpCooldownEvent(player, this.level().purpurConfig.playerExpPickupDelay, PlayerExpCooldownChangeEvent.ChangeReason.PICKUP_ORB).getNewCooldown(); // CraftBukkit - entityhuman.takeXpDelay = 2; // Purpur
+                // Canvas start
+                if(me.dueris.canvas.CanvasConfig.playerInstaAbsorbOrbs) {
+                    player.takeXpDelay = 0;
+                }
+                // Canvas end
                 player.take(this, 1);
                 int i = this.repairPlayerItems(player, this.value);
 
diff --git a/src/main/java/net/minecraft/world/entity/player/Player.java b/src/main/java/net/minecraft/world/entity/player/Player.java
index bf68f58294de7c0c993f6ab6240f02d6dae9439f..8a265a21f74657d7f2aac43cec080c3a5bba6436 100644
--- a/src/main/java/net/minecraft/world/entity/player/Player.java
+++ b/src/main/java/net/minecraft/world/entity/player/Player.java
@@ -633,7 +633,7 @@ public abstract class Player extends LivingEntity {
             while (iterator.hasNext()) {
                 Entity entity = (Entity) iterator.next();
 
-                if (entity.getType() == EntityType.EXPERIENCE_ORB && entity.level().purpurConfig.playerExpPickupDelay >= 0) { // Purpur
+                if ((entity.getType() == EntityType.EXPERIENCE_ORB && entity.level().purpurConfig.playerExpPickupDelay >= 0) && !me.dueris.canvas.CanvasConfig.playerInstaAbsorbOrbs) { // Purpur // Canvas
                     list1.add(entity);
                 } else if (!entity.isRemoved()) {
                     this.touch(entity);
