From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Dueris MC <purplewolf.mc1@gmail.com>
Date: Wed, 22 Nov 2023 09:00:21 +0000
Subject: [PATCH] Add createEndPlatformAPI


diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index b77cf89fea9310da85034a38f44bc3d5d74f71c2..81dbae111661151793a570197a345f1857508eeb 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -1272,7 +1272,7 @@ public class ServerPlayer extends Player {
                 if (resourcekey == LevelStem.OVERWORLD && worldserver.getTypeKey() == LevelStem.NETHER) { // CraftBukkit
                     this.enteredNetherPosition = this.position();
                 } else if (worldserver.getTypeKey() == LevelStem.END && shapedetectorshape.portalEventInfo != null && shapedetectorshape.portalEventInfo.getCanCreatePortal()) { // CraftBukkit
-                    this.createEndPlatform(worldserver, BlockPos.containing(shapedetectorshape.pos));
+                    this.createEndPlatform(worldserver, BlockPos.containing(shapedetectorshape.pos), true); // Canvas
                 }
                 // CraftBukkit start
             } else {
@@ -1355,7 +1355,7 @@ public class ServerPlayer extends Player {
     }
     // CraftBukkit end
 
-    private void createEndPlatform(ServerLevel world, BlockPos centerPos) {
+    public void createEndPlatform(ServerLevel world, BlockPos centerPos, boolean callEvent) { // Canvas - private -> public
         BlockPos.MutableBlockPos blockposition_mutableblockposition = centerPos.mutable();
         org.bukkit.craftbukkit.util.BlockStateListPopulator blockList = new org.bukkit.craftbukkit.util.BlockStateListPopulator(world); // CraftBukkit
 
@@ -1368,13 +1368,17 @@ public class ServerPlayer extends Player {
                 }
             }
         }
-        // CraftBukkit start - call portal event
-        org.bukkit.event.world.PortalCreateEvent portalEvent = new org.bukkit.event.world.PortalCreateEvent((List<org.bukkit.block.BlockState>) (List) blockList.getList(), world.getWorld(), this.getBukkitEntity(), org.bukkit.event.world.PortalCreateEvent.CreateReason.END_PLATFORM);
-        world.getCraftServer().getPluginManager().callEvent(portalEvent);
-        if (!portalEvent.isCancelled()) {
-            blockList.updateList();
+        // Canvas start
+        if(callEvent){
+            // CraftBukkit start - call portal event
+            org.bukkit.event.world.PortalCreateEvent portalEvent = new org.bukkit.event.world.PortalCreateEvent((List<org.bukkit.block.BlockState>) (List) blockList.getList(), world.getWorld(), this.getBukkitEntity(), org.bukkit.event.world.PortalCreateEvent.CreateReason.END_PLATFORM);
+            world.getCraftServer().getPluginManager().callEvent(portalEvent);
+            if (!portalEvent.isCancelled()) {
+                blockList.updateList();
+            }
+            // CraftBukkit end
         }
-        // CraftBukkit end
+        // Canvas end        
 
     }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 4cccd7c0cd6e1202a734a3a3247556f39bd233a2..ede21be60f7e5483e39bc250c3d139ed378c959c 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1340,6 +1340,24 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         this.lookAt(targetLocation, io.papermc.paper.entity.LookAnchor.EYES);
         // Paper end
     }
+    // Canvas start
+
+    @Override
+    public void createEndPlatformAtCurrentPos(){
+        this.createEndPlatformAtCurrentPos(false);
+    }
+
+    @Override
+    public void createEndPlatformAtCurrentPos(boolean callEvent){
+        ServerLevel level = ((CraftWorld) this.getWorld()).getHandle();
+        BlockPos pos = new BlockPos(
+            Math.toIntExact(carpetfixes.helpers.FastMath.round(this.getLocation().getX())),
+            Math.toIntExact(carpetfixes.helpers.FastMath.round(this.getLocation().getY())),
+            Math.toIntExact(carpetfixes.helpers.FastMath.round(this.getLocation().getZ()))
+        );
+        this.getHandle().createEndPlatform(level, pos, callEvent);
+    }
+    // Canvas end
 
     // Slice start
     public void teleportWithoutRespawn(Location location) {
